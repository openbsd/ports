$OpenBSD: patch-sysdeps_bsd_sysinfo_c,v 1.5 2010/04/17 12:05:13 ajacoutot Exp $
--- sysdeps/bsd/sysinfo.c.orig	Sun Apr 19 19:51:00 2009
+++ sysdeps/bsd/sysinfo.c	Sat Apr 17 13:55:55 2010
@@ -37,6 +37,9 @@ init_sysinfo (glibtop *server)
 {
 	char *model;
 	guint64 ncpus = 1;
+#if defined(__OpenBSD__)
+	int mib[2];
+#endif
 	int mhz = 0;
 	size_t len;
 
@@ -45,6 +48,33 @@ init_sysinfo (glibtop *server)
 
 	glibtop_init_s (&server, GLIBTOP_SYSDEPS_CPU, 0);
 
+#if defined(__OpenBSD__)
+	mib[0] = CTL_HW;
+
+	/* Get the number of CPU's present */
+	mib[1] = HW_NCPU;
+
+	len = sizeof(ncpus);
+	if (sysctl(mib, 2, &ncpus, &len, NULL, 0) != 0)
+		printf("Couldn't determine hw.ncpu.\n");
+
+	/* Get the CPU model */
+	mib[1] = HW_MODEL;
+	len = 0;
+
+	if (sysctl(mib, 2, NULL, &len, NULL, 0) != 0) {
+		model = g_malloc (len);
+		if (sysctl(mib, 2, model, &len, NULL, 0) != 0)
+			printf("Couldn't determine hw.model.\n");
+	}
+
+	/* Get the clockrate */
+	mib[1] = HW_CPUSPEED;
+	len = sizeof(mhz);
+
+	if (sysctl(mib, 2, &mhz, &len, NULL, 0) != 0)
+		printf("Couldn't determine hw.cpuspeed.\n");
+#else
 	len = sizeof (ncpus);
 	sysctlbyname ("hw.ncpu", &ncpus, &len, NULL, 0);
 	len = 0;
@@ -53,6 +83,8 @@ init_sysinfo (glibtop *server)
 	sysctlbyname ("hw.model", model, &len, NULL, 0);
 	len = sizeof (mhz);
 	sysctlbyname ("hw.clockrate", &mhz, &len, NULL, 0);
+
+#endif /* __OpenBSD__ */
 
 	for (sysinfo.ncpu = 0;
 	     sysinfo.ncpu < GLIBTOP_NCPU && sysinfo.ncpu < ncpus;
