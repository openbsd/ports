REVERT:
From 76534bcc5e4e0ee38b8541dbb413d4b36d30d9d7 Mon Sep 17 00:00:00 2001
From: Jordan Petridis <jordan@centricular.com>
Date: Sat, 29 Apr 2023 18:02:20 +0300
Subject: [PATCH] Drop consolekit backend and hard depend on systemd

From e4fac1586cce560b8c86791b1e6aa5eda6b71b7d Mon Sep 17 00:00:00 2001
From: Adrian Vovk <adrianvovk@gmail.com>
Date: Wed, 4 Jun 2025 18:34:25 -0400
Subject: [PATCH] main: Don't set XDG_CURRENT_DESKTOP

From 3d8b261e4d53d20be338ffe605f781cf07581617 Mon Sep 17 00:00:00 2001
From: Adrian Vovk <adrianvovk@gmail.com>
Date: Wed, 4 Jun 2025 19:39:00 -0400
Subject: [PATCH] main: Cleanup --disable-acceleration-check

Index: gnome-session/main.c
--- gnome-session/main.c.orig
+++ gnome-session/main.c
@@ -43,11 +43,14 @@
 #include "gsm-system.h"
 #include "gsm-fail-whale.h"
 
+#ifdef ENABLE_SYSTEMD_JOURNAL
 #include <systemd/sd-journal.h>
+#endif
 
 #define GSM_DBUS_NAME "org.gnome.SessionManager"
 
 static gboolean systemd_service = FALSE;
+static gboolean use_systemd = USE_SYSTEMD_SESSION;
 static gboolean failsafe = FALSE;
 static gboolean show_version = FALSE;
 static gboolean debug = FALSE;
@@ -55,7 +58,6 @@ static gboolean please_fail = FALSE;
 static gboolean disable_acceleration_check = FALSE;
 static const char *session_name = NULL;
 static GsmManager *manager = NULL;
-static char *gl_renderer = NULL;
 
 static GMainLoop *loop;
 
@@ -255,6 +257,7 @@ initialize_gio (void)
         }
 }
 
+#ifdef ENABLE_SYSTEMD_SESSION
 static gboolean
 leader_term_or_int_signal_cb (gpointer data)
 {
@@ -460,6 +463,7 @@ systemd_leader_run(void)
         gsm_main ();
         exit(0);
 }
+#endif /* ENABLE_SYSTEMD_SESSION */
 
 int
 main (int argc, char **argv)
@@ -473,7 +477,11 @@ main (int argc, char **argv)
         guint             name_owner_id;
         GOptionContext   *options;
         static GOptionEntry entries[] = {
+#ifdef ENABLE_SYSTEMD_SESSION
                 { "systemd-service", 0, 0, G_OPTION_ARG_NONE, &systemd_service, N_("Running as systemd service"), NULL },
+                { "systemd", 0, 0, G_OPTION_ARG_NONE, &use_systemd, N_("Use systemd session management"), NULL },
+#endif
+                { "builtin", 0, G_OPTION_FLAG_REVERSE, G_OPTION_ARG_NONE, &use_systemd, N_("Use builtin session management (rather than the systemd based one)"), NULL },
                 { "autostart", 'a', 0, G_OPTION_ARG_STRING_ARRAY, &override_autostart_dirs, N_("Override standard autostart directories"), N_("AUTOSTART_DIR") },
                 { "session", 0, 0, G_OPTION_ARG_STRING, &opt_session_name, N_("Session to use"), N_("SESSION_NAME") },
                 { "debug", 0, 0, G_OPTION_ARG_NONE, &debug, N_("Enable debugging code"), NULL },
@@ -490,15 +498,6 @@ main (int argc, char **argv)
                 gsm_util_init_error (TRUE, "%s", error->message);
         }
 
-        /* From 3.14 GDM sets XDG_CURRENT_DESKTOP. For compatibility with
-         * older versions of GDM,  other display managers, and startx,
-         * set a fallback value if we don't find it set.
-         */
-        if (g_getenv ("XDG_CURRENT_DESKTOP") == NULL) {
-            g_setenv("XDG_CURRENT_DESKTOP", "GNOME", TRUE);
-            gsm_util_setenv ("XDG_CURRENT_DESKTOP", "GNOME");
-        }
-
         /* Make sure we initialize gio in a way that does not autostart any daemon */
         initialize_gio ();
 
@@ -528,10 +527,14 @@ main (int argc, char **argv)
                 exit (0);
         }
 
+        if (disable_acceleration_check)
+                g_warning ("Wayland assumes that acceleration works, so --disable-acceleration-check is deprecated!");
+
         /* Rebind stdout/stderr to the journal explicitly, so that
          * journald picks ups the nicer "gnome-session" as the program
          * name instead of whatever shell script GDM happened to use.
          */
+#ifdef ENABLE_SYSTEMD_JOURNAL
         if (!debug) {
                 int journalfd;
 
@@ -541,6 +544,7 @@ main (int argc, char **argv)
                         dup2(journalfd, 2);
                 }
         }
+#endif
 
         gdm_log_init ();
         gdm_log_set_debug (debug);
@@ -576,12 +580,15 @@ main (int argc, char **argv)
 
         session_name = opt_session_name;
 
+#ifdef HAVE_SYSTEMD
         gsm_util_export_user_environment (&error);
         if (error && !g_getenv ("RUNNING_UNDER_GDM"))
                 g_warning ("Failed to upload environment to systemd: %s", error->message);
         g_clear_error (&error);
+#endif
 
-        if (!systemd_service) {
+#ifdef ENABLE_SYSTEMD_SESSION
+        if (use_systemd && !systemd_service) {
                 const gchar *session_type = NULL;
                 g_autofree gchar *gnome_session_target = NULL;
 
@@ -628,6 +635,7 @@ main (int argc, char **argv)
                         exit (1);
                 }
         }
+#endif /* ENABLE_SYSTEMD_SESSION */
 
         {
                 gchar *ibus_path;
@@ -664,10 +672,11 @@ main (int argc, char **argv)
 
         gsm_main ();
 
+#ifdef HAVE_SYSTEMD
         gsm_util_export_user_environment (NULL);
+#endif
 
         g_clear_object (&manager);
-        g_free (gl_renderer);
 
         g_bus_unown_name (name_owner_id);
         gdm_log_shutdown ();
