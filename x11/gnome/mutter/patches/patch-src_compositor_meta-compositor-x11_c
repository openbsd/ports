From a25c35c16d0f161fb3d73e7f35fd68ccb78b1217 Mon Sep 17 00:00:00 2001
From: duli <duli4868@gmail.com>
Date: Mon, 3 Nov 2025 19:43:54 +0800
Subject: [PATCH] x11: Handle ignored modifiers when grabbing keys and buttons

Index: src/compositor/meta-compositor-x11.c
--- src/compositor/meta-compositor-x11.c.orig
+++ src/compositor/meta-compositor-x11.c
@@ -67,11 +67,14 @@ typedef struct
   MetaCompositorX11 *compositor_x11;
   Window xwindow;
   gboolean grab;
+  MetaKeyBindingManager *keys;
 } KeyGrabData;
 
 G_DEFINE_TYPE (MetaCompositorX11, meta_compositor_x11, META_TYPE_COMPOSITOR)
 
 static void meta_compositor_x11_grab_root_window_keys (MetaCompositorX11 *compositor_x11);
+static GArray *calc_keygrab_modifiers (xkb_mod_mask_t ignored_modifier_mask,
+                                       unsigned int   modmask);
 
 static void
 process_damage (MetaCompositorX11  *compositor_x11,
@@ -430,24 +433,28 @@ meta_change_button_grab (MetaCompositorX11   *composit
   MetaBackend *backend =
     meta_compositor_get_backend (META_COMPOSITOR (compositor_x11));
   MetaBackendX11 *backend_x11 = META_BACKEND_X11 (backend);
+  MetaDisplay *display = meta_compositor_get_display (META_COMPOSITOR (compositor_x11));
+  MetaKeyBindingManager *keys = &display->key_binding_manager;
   Window xwindow;
 
   xwindow = meta_window_x11_get_toplevel_xwindow (window);
 
+  GArray *mods = calc_keygrab_modifiers (keys->ignored_modifier_mask, modmask);
+
   if (grab)
     {
       meta_backend_x11_passive_button_grab (backend_x11,
                                             xwindow,
                                             button,
                                             grab_mode,
-                                            modmask);
+                                            mods);
     }
   else
     {
       meta_backend_x11_passive_button_ungrab (backend_x11,
                                               xwindow,
                                               button,
-                                              modmask);
+                                              mods);
     }
 }
 
@@ -540,15 +547,49 @@ meta_compositor_x11_ungrab_focus_window_button (MetaCo
                             META_GRAB_MODE_ASYNC, 0);
 }
 
+static GArray *
+calc_keygrab_modifiers (xkb_mod_mask_t ignored_modifier_mask,
+                        unsigned int   modmask)
+{
+  unsigned int subset_mask;
+  XIGrabModifiers mods;
+  GArray *mods_array = g_array_new (FALSE, TRUE, sizeof (XIGrabModifiers));
+
+  if (modmask == 0 || (modmask & XIAnyModifier))
+    {
+      mods = (XIGrabModifiers){XIAnyModifier, 0};
+      g_array_append_val (mods_array, mods);
+      return mods_array;
+    }
+
+  mods = (XIGrabModifiers) { modmask, 0 };
+  g_array_append_val (mods_array, mods);
+
+  for (subset_mask = 1;
+       subset_mask <= ignored_modifier_mask;
+       ++subset_mask)
+    {
+      if (subset_mask & ignored_modifier_mask)
+        {
+          mods = (XIGrabModifiers) { modmask | subset_mask, 0 };
+          g_array_append_val (mods_array, mods);
+        }
+    }
+
+  return mods_array;
+}
+
 static void
-meta_compositor_x11_change_keygrab (MetaCompositorX11    *compositor_x11,
-                                    Window                xwindow,
-                                    gboolean              grab,
-                                    MetaResolvedKeyCombo *resolved_combo)
+meta_compositor_x11_change_keygrab (MetaCompositorX11     *compositor_x11,
+                                    Window                 xwindow,
+                                    gboolean               grab,
+                                    MetaKeyBindingManager *keys,
+                                    MetaResolvedKeyCombo  *resolved_combo)
 {
   MetaBackend *backend =
     meta_compositor_get_backend (META_COMPOSITOR (compositor_x11));
   MetaBackendX11 *backend_x11 = META_BACKEND_X11 (backend);
+  xkb_mod_mask_t ignored_modifier_mask = keys->ignored_modifier_mask;
   int i;
 
   for (i = 0; i < resolved_combo->len; i++)
@@ -560,18 +601,20 @@ meta_compositor_x11_change_keygrab (MetaCompositorX11 
                   grab ? "Grabbing" : "Ungrabbing",
                   keycode, resolved_combo->mask, xwindow);
 
+      GArray *mods = calc_keygrab_modifiers (ignored_modifier_mask, resolved_combo->mask);
+
       if (grab)
         {
           meta_backend_x11_passive_key_grab (backend_x11, xwindow,
                                              keycode,
                                              META_GRAB_MODE_SYNC,
-                                             resolved_combo->mask);
+                                             mods);
         }
       else
         {
           meta_backend_x11_passive_key_ungrab (backend_x11, xwindow,
                                                keycode,
-                                               resolved_combo->mask);
+                                               mods);
         }
     }
 }
@@ -598,6 +641,7 @@ passive_key_grab_foreach (MetaDisplay          *displa
   meta_compositor_x11_change_keygrab (data->compositor_x11,
                                       data->xwindow,
                                       data->grab,
+                                      data->keys,
                                       resolved_combo);
 }
 
@@ -607,7 +651,8 @@ meta_compositor_x11_grab_window_keys (MetaCompositorX1
 {
   MetaCompositor *compositor = META_COMPOSITOR (compositor_x11);
   MetaDisplay *display = meta_compositor_get_display (compositor);
-  KeyGrabData data = { compositor_x11, xwindow, TRUE };
+  MetaKeyBindingManager *keys = &display->key_binding_manager;
+  KeyGrabData data = { compositor_x11, xwindow, TRUE, keys };
 
   meta_display_keybinding_foreach (display,
                                    passive_key_grab_foreach,
@@ -620,7 +665,8 @@ meta_compositor_x11_ungrab_window_keys (MetaCompositor
 {
   MetaCompositor *compositor = META_COMPOSITOR (compositor_x11);
   MetaDisplay *display = meta_compositor_get_display (compositor);
-  KeyGrabData data = { compositor_x11, xwindow, FALSE };
+  MetaKeyBindingManager *keys = &display->key_binding_manager;
+  KeyGrabData data = { compositor_x11, xwindow, FALSE, keys };
 
   meta_display_keybinding_foreach (display,
                                    passive_key_grab_foreach,
@@ -634,7 +680,8 @@ meta_compositor_x11_grab_root_window_keys (MetaComposi
   MetaDisplay *display = meta_compositor_get_display (compositor);
   MetaX11Display *x11_display = display->x11_display;
   Window xroot = x11_display->xroot;
-  KeyGrabData data = { compositor_x11, xroot, TRUE };
+  MetaKeyBindingManager *keys = &display->key_binding_manager;
+  KeyGrabData data = { compositor_x11, xroot, TRUE, keys };
 
   if (compositor_x11->have_root_window_key_grab)
     return;
@@ -652,7 +699,8 @@ meta_compositor_x11_ungrab_root_window_keys (MetaCompo
   MetaDisplay *display = meta_compositor_get_display (compositor);
   MetaX11Display *x11_display = display->x11_display;
   Window xroot = x11_display->xroot;
-  KeyGrabData data = { compositor_x11, xroot, FALSE };
+  MetaKeyBindingManager *keys = &display->key_binding_manager;
+  KeyGrabData data = { compositor_x11, xroot, FALSE, keys };
 
   if (!compositor_x11->have_root_window_key_grab)
     return;
