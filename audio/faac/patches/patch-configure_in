--- configure.in.orig	Mon Aug 20 11:03:22 2007
+++ configure.in	Thu Jul 10 23:55:40 2008
@@ -10,8 +10,6 @@ AC_ARG_ENABLE( drm,  [  --enable-drm            Digita
 
 AC_DEFUN(MY_DEFINE, [ AC_DEFINE($1, 1, [define if needed]) ])
 
-CFLAGS=${CFLAGS:-"-O2 -Wall"}
-
 AC_PROG_CC
 AC_PROG_CXX
 AM_PROG_LIBTOOL
@@ -31,7 +29,7 @@ AM_CONDITIONAL(WITH_MP4V2, false)
 
 AC_CHECK_DECLS([MP4Create, MP4MetadataDelete],
                AC_CHECK_LIB(mp4v2, MP4MetadataDelete, external_mp4v2=yes,
-                            external_mp4v2=no, -lstdc++),
+                            external_mp4v2=no, -lstdc++ -lm),
                external_mp4v2=no, [#include <mp4.h>])
 
 if test x$external_mp4v2 = xyes; then
@@ -39,12 +37,17 @@ if test x$external_mp4v2 = xyes; then
 else
   if test x$WITHMP4V2 = xyes; then
      AC_MSG_NOTICE([*** Building with internal mp4v2 ***])
-     AM_CONDITIONAL(WITH_MP4V2, true)
-     AC_CONFIG_LINKS(common/mp4v2/mpeg4ip_config.h:config.h)
-     MY_DEFINE(HAVE_LIBMP4V2)
   else
      AC_MSG_NOTICE([*** Building WITHOUT mp4v2 ***])
   fi
+fi
+
+if test x$external_mp4v2 = xyes -o x$WITHMP4V2 = xyes; then
+     AM_CONDITIONAL(WITH_MP4V2, true)
+    if test x$external_mp4v2 != xyes; then
+     AC_CONFIG_LINKS(common/mp4v2/mpeg4ip_config.h:config.h)
+    fi
+     MY_DEFINE(HAVE_LIBMP4V2)
 fi
 
 dnl Check for DRM mode
