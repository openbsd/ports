# XXX no i386 equivalent to mem_openbsd_amd64.go
ONLY_FOR_ARCHS=		amd64

COMMENT=		service discovery and configuration tool

VERSION=		1.18.0
PKGNAME=		consul-${VERSION}

# consul-vendored distfile generated by fetching archive from
# https://github.com/hashicorp/consul/archive/v$VERSION/consul-$VERSION.tar.gz
# and running "go mod tidy" + "go mod vendor"
DISTNAME=		consul-vendored-${VERSION}
SITES=			https://distfiles.bsdfrog.org/
ALL_TARGET=		github.com/hashicorp/consul

# XXX go get go.etcd.io/bbolt && go get golang.org/x/sys
DISTNAME=		consul-vendored-syscall_fix-${VERSION}

CATEGORIES=		sysutils net

HOMEPAGE=		https://www.consul.io/

MAINTAINER=		Antoine Jacoutot <ajacoutot@openbsd.org>

# BSL-1.1 (https://www.hashicorp.com/bsl)
PERMIT_PACKAGE=		Yes

WANTLIB += c pthread

MODULES=		lang/go

# go/src/github.com/hashicorp/consul/scripts/build.sh
# go/src/github.com/hashicorp/consul/version/version.go
MODGO_LDFLAGS +=	-X github.com/hashicorp/consul/version.GitDescribe=${VERSION}
MODGO_LDFLAGS +=	-X github.com/hashicorp/consul/version.Version=${VERSION}
MODGO_LDFLAGS +=	-X github.com/hashicorp/consul/version.VersionPrerelease="" # empty

SUBST_VARS +=		VERSION
post-patch:
	${SUBST_CMD} ${WRKDIST}/agent/uiserver/dist/index.html

post-install:
	${INSTALL_DATA_DIR} ${PREFIX}/share/examples/consul
	${SUBST_CMD} -c -m 0640 ${WRKSRC}/.release/linux/package/etc/consul.d/consul.hcl \
		${PREFIX}/share/examples/consul/consul.hcl

.include <bsd.port.mk>
