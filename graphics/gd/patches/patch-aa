--- Makefile.orig	Sat Jun  3 15:26:12 2000
+++ Makefile	Wed Jun 21 23:09:24 2000
@@ -51,13 +51,13 @@
 LIBDIRS=-L. -L/usr/local/lib -L/usr/lib/X11 -L/usr/X11R6/lib
 
 #Location where libgd.a should be installed by "make install".
-INSTALL_LIB=/usr/local/lib
+INSTALL_LIB=$(PREFIX)/lib
 
 #Location where .h files should be installed by "make install".
-INSTALL_INCLUDE=/usr/local/include
+INSTALL_INCLUDE=$(PREFIX)/include
 
 #Location where useful non-test programs should be installed by "make install".
-INSTALL_BIN=/usr/local/bin
+INSTALL_BIN=$(PREFIX)/bin
 
 #
 #
@@ -74,27 +74,39 @@
 
 BIN_PROGRAMS=pngtogd pngtogd2 gdtopng gd2topng gd2copypal gdparttopng webpng
 TEST_PROGRAMS=gdtest gddemo gd2time gdtestttf
+VER=18.3
 
+.if defined(NO_SHARED_LIBS) && ${NO_SHARED_LIBS:U} == YES
 all: libgd.a $(PROGRAMS)
+.else
+all: libgd.a libgd.so.${VER} $(PROGRAMS)
+.endif
 
+.if defined(NO_SHARED_LIBS) && ${NO_SHARED_LIBS:U} == YES
 install: libgd.a $(BIN_PROGRAMS)
-	sh ./install-item 644 libgd.a $(INSTALL_LIB)/libgd.a
-	sh ./install-item 755 pngtogd $(INSTALL_BIN)/pngtogd
-	sh ./install-item 755 pngtogd2 $(INSTALL_BIN)/pngtogd2
-	sh ./install-item 755 gdtopng $(INSTALL_BIN)/gdtopng
-	sh ./install-item 755 gd2topng $(INSTALL_BIN)/gd2topng
-	sh ./install-item 755 gd2copypal $(INSTALL_BIN)/gd2copypal
-	sh ./install-item 755 gdparttopng $(INSTALL_BIN)/gdparttopng
-	sh ./install-item 755 webpng $(INSTALL_BIN)/webpng
-	sh ./install-item 755 bdftogd $(INSTALL_BIN)/bdftogd
-	sh ./install-item 644 gd.h $(INSTALL_INCLUDE)/gd.h
-	sh ./install-item 644 gdcache.h $(INSTALL_INCLUDE)/gdcache.h
-	sh ./install-item 644 gd_io.h $(INSTALL_INCLUDE)/gd_io.h
-	sh ./install-item 644 gdfontg.h $(INSTALL_INCLUDE)/gdfontg.h
-	sh ./install-item 644 gdfontl.h $(INSTALL_INCLUDE)/gdfontl.h
-	sh ./install-item 644 gdfontmb.h $(INSTALL_INCLUDE)/gdfontmb.h
-	sh ./install-item 644 gdfonts.h $(INSTALL_INCLUDE)/gdfonts.h
-	sh ./install-item 644 gdfontt.h $(INSTALL_INCLUDE)/gdfontt.h
+.else
+install: libgd.a libgd.so.${VER} $(BIN_PROGRAMS)
+.endif
+	$(BSD_INSTALL_DATA) -m 644 libgd.a $(INSTALL_LIB)
+	@if [ -f libgd.so.${VER} ]; then \
+	 $(BSD_INSTALL_DATA) -m 644 libgd.so.${VER} $(INSTALL_LIB); \
+	fi
+	$(BSD_INSTALL_PROGRAM) pngtogd $(INSTALL_BIN)
+	$(BSD_INSTALL_PROGRAM) pngtogd2 $(INSTALL_BIN)
+	$(BSD_INSTALL_PROGRAM) gdtopng $(INSTALL_BIN)
+	$(BSD_INSTALL_PROGRAM) gd2topng $(INSTALL_BIN)
+	$(BSD_INSTALL_PROGRAM) gd2copypal $(INSTALL_BIN)
+	$(BSD_INSTALL_PROGRAM) gdparttopng $(INSTALL_BIN)
+	$(BSD_INSTALL_PROGRAM) webpng $(INSTALL_BIN)
+	$(BSD_INSTALL_PROGRAM) bdftogd $(INSTALL_BIN)
+	$(BSD_INSTALL_DATA) gd.h $(INSTALL_INCLUDE)
+	$(BSD_INSTALL_DATA) gdcache.h $(INSTALL_INCLUDE)
+	$(BSD_INSTALL_DATA) gd_io.h $(INSTALL_INCLUDE)
+	$(BSD_INSTALL_DATA) gdfontg.h $(INSTALL_INCLUDE)
+	$(BSD_INSTALL_DATA) gdfontl.h $(INSTALL_INCLUDE)
+	$(BSD_INSTALL_DATA) gdfontmb.h $(INSTALL_INCLUDE)
+	$(BSD_INSTALL_DATA) gdfonts.h $(INSTALL_INCLUDE)
+	$(BSD_INSTALL_DATA) gdfontt.h $(INSTALL_INCLUDE)
 
 gddemo: gddemo.o libgd.a
 	$(CC) gddemo.o -o gddemo	$(LIBDIRS) $(LIBS)
@@ -131,15 +143,23 @@
 
 libgd.a: gd.o gd_gd.o gd_gd2.o gd_io.o gd_io_dp.o gd_io_file.o gd_ss.o \
 	gd_io_ss.o gd_png.o gd_jpeg.o gdxpm.o gdfontt.o gdfonts.o gdfontmb.o gdfontl.o \
-	gdfontg.o gdtables.o gdttf.o gdcache.o gdkanji.o  wbmp.o gd_wbmp.o \
-	gd.h gdfontt.h gdfonts.h gdfontmb.h gdfontl.h gdfontg.h
-	rm -f libgd.a
-	$(AR) rc libgd.a gd.o gd_gd.o gd_gd2.o gd_io.o gd_io_dp.o \
-		gd_io_file.o gd_ss.o gd_io_ss.o gd_png.o gd_jpeg.o gdxpm.o \
-		gdfontt.o gdfonts.o gdfontmb.o gdfontl.o gdfontg.o \
-		gdtables.o gdttf.o gdcache.o gdkanji.o wbmp.o gd_wbmp.o
-	-ranlib libgd.a
+	gdfontg.o gdtables.o gdttf.o gdcache.o gdkanji.o wbmp.o gd_wbmp.o
+	rm -f ${.TARGET}
+	$(AR) rc ${.TARGET} ${.ALLSRC}
+	-ranlib ${.TARGET}
+
+libgd.so.${VER}: gd.so gd_gd.so gd_gd2.so gd_io.so gd_io_dp.so gd_io_file.so \
+	gd_ss.so gd_io_ss.so gd_png.so gd_jpeg.so gdxpm.so gdfontt.so gdfonts.so \
+	gdfontmb.so gdfontl.so gdfontg.so gdtables.so gdttf.so gdcache.so \
+	gdkanji.so wbmp.o gd_wbmp.so
+	rm -f ${.TARGET}
+	ld -Bshareable -Bforcearchive -o ${.TARGET} ${.ALLSRC}
 
 clean:
-	rm -f *.o *.a ${PROGRAMS} test/gdtest.jpg test/gdtest.wbmp
+	rm -f *.o ${PROGRAMS} libgd.a libgd.so.${VER} test/gdtest.jpg test/gdtest.wbmp
 
+.SUFFIXES: .c .o .so
+.c.o:
+	${CC} ${CFLAGS} -c ${.IMPSRC} -o ${.TARGET}
+.c.so:
+	${CC} ${CFLAGS} -fpic -DPIC -c ${.IMPSRC} -o ${.TARGET}
